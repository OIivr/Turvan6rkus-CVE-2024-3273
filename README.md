# ðŸ› ï¸ D-Link VÃµrgumÃ¤lu Seadmete KÃ¤susÃ¼st

## ðŸŒŸ Taust

*D-Link Network Attached Storage* (NAS) ehk **vÃµrgumÃ¤lu** seade on arvutivÃµrku Ã¼hendatav kÃµvakettaga (vÃµi -ketastega) seade failide talletuseks ja Ã¼hiskasutuseks. Erinevalt tavalisest vÃ¤lisest kÃµvakettast, mis on liidestatud otse arvutiga, Ã¼hendub vÃµrgumÃ¤lu seade kohtvÃµrguga, vÃµimaldades mitmel kasutajal vÃµi seadmel Ã¼heaegselt faile kasutada ja jagada. VÃµrgumÃ¤lu seadmed on kasutusel nii kodu- kui ka Ã¤rilahendustes.

Turvauuringuid koostav ettevÃµte *VulDB Coordination* avastas osadel D-Link vÃµrgumÃ¤lu seadmetel kriitilise turvanÃµrkuse (CVE-2024-3273), mis vÃµimaldab pahatahtlikel kasutajatel teha Ã¼le vÃµrgu kÃ¤susÃ¼ste, kÃ¤ivitades pahatahtlikke programmikÃ¤ske ohvri seadmes.

## âš™ï¸ Turvaauk

### Eeltingimused

KÃ¤esolev turvanÃµrkus puudutab vaid teatud D-Link seadmeid, mille eluiga on juba lÃ¤bi ning tootja on nende seadmete tarkvaralise ja riistvaralise toetamise lÃµpetanud. MÃµjutatud on jÃ¤rgmised mudelid:

- **DNS-320L** Version 1.11, Version 1.03.0904.2013, Version 1.01.0702.2013
- **DNS-325** Version 1.01
- **DNS-327L** Version 1.09, Version 1.00.0409.2013
- **DNS-340L** Version 1.08

Antud turvanÃµrkus eeldab ka Ã¼he teise nÃµrkuse samaaegset Ã¤rakasutamist. Nimelt muudab vÃµrgumÃ¤lu seadme eriti haavatavaks pÃ¼siprogrmmeeritud sisselogimissuvandite pÃµhjustatud tagauks. Selleks tagaukseks on turvanÃµrkus (CVE-2024-3272), kus kasutajal on vÃµimalik autentimisest mÃ¶Ã¶da pÃ¤Ã¤seda kasutades vaikimisi kÃµigis mÃµjutatud seadmetes olevat *"sÃ¼steemikasutajat"* messagebus.

Selle Linux sÃ¼steemides vaikimisi oleva sÃ¼steemi deemon (*system daemon*) kasutajaga ei saa kÃ¼ll otseselt sÃ¼steemi sisse logida, kuid piisab osavalt meisterdatud HTTP pÃ¤ringust kindlasse otspunkti, et juba kahju teha.

Vaja on teada ka rÃ¼nnatava seadme `ip addressi`.

### Turvaaugu avaldumine

TurvanÃµrkus peitub vÃµrgumÃ¤lu seadme `/cgi-bin/nas_sharing.cgi` failis HTTP GET pÃ¤ringu tÃ¶Ã¶tlemisfunktsioonis. Pahatahtlikul kasutajal on vÃµimalik saata GET pÃ¤ring Ã¼le vÃµrgu ohvri seadmesse andes parameetritena kaasa kasutajanimi `"messagebus"` ja `parool jÃ¤tta tÃ¼hjaks`. KÃ¤susÃ¼st tuleb siin mÃ¤ngu `system` parameetrit kasutades, mÃ¤Ã¤rates parameetri vÃ¤Ã¤rtuseks soovitud programmikÃ¤su.

KÃ¤sk peidetakse **base64** kodeeringuga ning lisatakse **system** parameetri vÃ¤Ã¤rtuseks. Hiljem dekodeerides avaldub pahatahtlik kÃ¤sujupp mis kÃ¤ivitub *shell* kÃ¤suna rÃ¼nnatavas seadmes.

ðŸ—’ï¸ [CVSS](https://nvd.nist.gov/vuln/detail/CVE-2024-3273) Baasskoor: `7.3 KÃµrge`

- AV: N - NÃµrkus on Ã¤ra kasutatav Ã¼le vÃµrgu.
- AC: L - RÃ¼nnaku keerukus on madal, kuna rÃ¼nnakuks vajalikud vahendid on lihtsasti kÃ¤ttesaadavad.
- PR: N - RÃ¼nnakuks ei ole vaja eraldi privileege.
- UI: N - Kasutaja interaktsioon ei ole vajalik.
- S: U - Puudutab vaid kindlaid mudeleid ja ei laiene Ã¼le teistele seadmetele.
- C: L - Konfidentsiaalsuse mÃµju on madal, kuna rÃ¼nnak ei paljasta olulist konfidentsiaalset teavet.
- I: L - Terviklikkuse mÃµju on madal, kuna rÃ¼nnak ei muuda oluliselt sÃ¼steemi andmeid ega konfiguratsiooni.
- A: L - kÃ¤ideldavuse mÃµju on madal, kuna rÃ¼nnak ei pÃµhjusta teenuste katkemist.

### Turvaaugu pÃµhjused

TurvanÃµrkuse CVE-2024-3273 pÃµhjuseks on `CWE-77` ehk kÃ¤susÃ¼st. See tÃ¤hendab, et rÃ¼ndaja saab sisestada pahatahtlikke kÃ¤ske, mida rÃ¼nnatav sÃ¼steem seejÃ¤rel tÃ¤idab, kuna sisestatud kÃ¤sku ei valideerita.

Kuna seadmete lÃ¤htekood pole avalik siis arvatavasti tuleks selle probleemi vÃ¤ltimiseks lisada pÃ¤ringutega tegelevasse meetodisse valideerimisfunktsioon. NÃ¤iteks vÃµiks olla list lubatud sÃ¼steemi kÃ¤skudest, et vÃ¤ltida suvalise kÃ¤su jooksutamist.

## ðŸ›¡ï¸ MÃµju ja turvaaugu kÃµrvaldamine

### MÃµju varadele

TurvanÃµrkus rikub peamiselt jÃ¤rgmisi turvaeesmÃ¤rke:

- **Konfidentsiaalsus**: RÃ¼ndaja vÃµib saada juurdepÃ¤Ã¤su konfidentsiaalsetele andmetele, nt isiklikud andmed vÃµi Ã¤risaladused
- **Privaatsus**: Saades ligipÃ¤Ã¤su konfidentsiaalsetele andmetele vÃµib see rikkuda kasutaja privaatsust.
- **Terviklus**: RÃ¼ndajal on vÃµimalik muuta andmeid ja sÃ¼steemi seadeid
- **UsaldusvÃ¤Ã¤rsus**: Haavatavate D-Link seadmete kasutajad vÃµivad kaotada usalduse tootja vastu.

### Turvaaugu parandamine

Antud turvanÃµrkus puudutab vaid seadmeid, mille eluiga on juba lÃ¤bi, seega soovitab tootja seadmed asendada ning haavatavaid seadmeid mitte kasutada. 

Kuna neid seadmeid enam ei toetata, siis ei saa need enam ka tarkvaralisi turvauuendusi, mis tÃ¤hendab et turvaauku Ã¤ra `ei parandata`. Seega ainuke lahendus on turvaauguga toodete kasutamine lÃµpetada.

### Turvaaaugu mÃµju leevendamine

Kui haavatava seadme asendamine pole vÃµimalik, tuleks seade kindlasti eemaldada avalikust vÃµrgust ning Ã¤Ã¤rmisel juhul olla kasutuses vaid lokaalses kohtvÃµrgus olevatele seadmetele (tuleks paigaldada tulemÃ¼Ã¼r vÃ¤liste pÃ¤ringute blokkeerimiseks).

### Turvaaugu tegelik Ã¤rakasutatavus

Esialgse raporti kohaselt oli turvaaugu avastamise hetkel vÃµrgus Ã¼le `92 000 seadme`. Hilisema uuringu kohaselt vÃµis see number olla aga oluliselt vÃ¤iksem, jÃ¤Ã¤des 5500 seadme kanti. Sellest hoolimata on tÃ¤na veel tÃµenÃ¤oliselt paljud vanad seadmed veel endiselt vÃµrku Ã¼hendatud ja seelÃ¤bi haavatavad.

Avaldatud on mitmeid rÃ¼nnaku kontseptsiooni tÃµendusi (*PoC*) ning tÃµenÃ¤oliselt kasutatakse turvaauku endiselt laialdaselt Ã¤ra. Praeguseks hetkeks on avastatud vÃ¤hemalt `146 juhtumit`, kus on proovitud Ã¤ra kasutada CVE-2024-3273 turvanÃµrkust.

## ðŸ”§ NÃ¤idiskood

Jupp nÃ¤idiskoodist:

```python
def execute_command(ip, command: str = "id", verbose: bool = True) -> str:
    command_hex = ''.join(f'\\\\x{ord(c):02x}' for c in command)
    command_final = f"echo -e {command_hex}|sh".replace(' ', '\t')
    base64_cmd: str = base64.b64encode(command_final.encode()).decode()
    url: str = f"{ip}/cgi-bin/nas_sharing.cgi"
    params: dict = {
        "user": "messagebus",
        "passwd": "",
        "cmd": "15",
        "system": base64_cmd,
    }
```
